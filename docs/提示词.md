你现在是本机 coding agent，请在 `/home/fengde/SAIL` 继续执行 Zabha 主线任务。目标：在尽量少人工交互下，自循环推进任务，并以“测试验收”作为阶段完成标准。

你需要每次任务完成的时候，都把docs里面需要更新的文件更新了（至少提示词md需要更新，其他的自行决定）
每一次完成任务之后commit一次，不要过于频繁也不要过于稀疏
提示词有可能过时，但如果你每次任务完成都更新提示词md，就会很新
需要sudo 我来帮你执行
如果你遇到了什么命令阻塞 我也可以帮你执行

## 0. 会话恢复（每次重启先做）
1. `cd /home/fengde/SAIL`
2. 读取并总结当前状态（禁止跳过）：
   - `docs/AGENT_STATE.json`
   - `docs/TASK_QUEUE.json`
   - `docs/RUN_LOG.md`
   - `docs/CONTEXT_BRIEF.md`（如存在）
3. 执行一次快速环境检查并记录结果（写入 `docs/RUN_LOG.md`）：
   - `command -v riscof spike sail_riscv_sim riscv64-unknown-elf-gcc || true`
   - `.venv`、`tools/spike`、`sail-riscv/build` 是否存在

## 1. 执行原则（硬性）
1. 非必要不提问：除非遇到“必须用户确认/授权/外网凭据/系统权限”才停。
2. 自循环执行：按任务队列顺序自动推进；每轮都回写状态与日志。
3. 频繁提交：每个可验证子任务完成后立即 commit，便于回滚。
4. 测试验收优先：每个阶段以测试命令或可复现检查通过作为 done 条件。
5. shell 环境是 `zsh`。

## 2. 任务状态同步规则
- 每轮任务都要同步三处：
  - `docs/AGENT_STATE.json`
  - `docs/TASK_QUEUE.json`
  - `docs/RUN_LOG.md`
- 状态值统一：`pending | in_progress | blocked | done`
- 若 blocked，必须记录：
  - 失败命令
  - 关键报错
  - 最小下一步

## 3. commit 规则（必须执行）
- 粒度：一个可验收子任务一个 commit。
- message 模板：
  - `chore(loop): ...`
  - `build(env): ...`
  - `test(riscof): ...`
  - `docs(state): ...`
- commit 前最少检查：
  - 相关脚本可执行
  - 对应验收命令已跑（成功或失败都有日志）

## 4. 当前项目快照（重启后先核对）
- 已有：
  - `riscof` 在 `.venv` 中可用
  - `spike` 目标路径：`/home/fengde/SAIL/tools/spike/bin/spike`
  - Zabha/Zacas 测试与部分配置已落地
  - `sail` 已安装到本地 opam switch：`/home/fengde/SAIL/.opam/5.1.1/bin/sail`
  - `z3` 已由系统包安装，可正常执行 `z3 --version`
  - `tools/no_ccache_bin/ccache` shim 已修复，可绕过异常 ccache 参数导致的 dune/opam 编译失败
  - `sail_riscv_sim` 已可执行，`riscof` 链路已进入可运行状态
  - 新增统一入口：`scripts/run_riscof_zabha_auto.sh`（单命令自动分阶段：phase1~phase5）
  - 阶段进度：`phase1`、`phase2`、`phase3` 已通过；`phase4` 拆为 24 块，`phase4_1`～`phase4_3` 已通过（各 79/79），下一步为 `phase4_4`
- 主要阻塞：
  - 本机 `riscv64-unknown-elf-gcc/binutils` 不支持 `Zabha` 指令（`amoadd.b`/`-march ... zabha` 报 unrecognized）
  - 因工具链限制，`M3-004` 的 `phase5`（full Zabha）预计 blocked；兼容子集阶段可稳定推进
  - 若外网不可用，`opam` 拉取依赖会失败
  - 若需 full Zabha 验收，需要切换到支持 Zabha 的 GNU toolchain

## 5. 默认执行顺序（继续开发时）
1. 先跑最小验收脚本（例如 `scripts/check_min.sh`）确认基线。
2. 按 `docs/TASK_QUEUE.json` 取下一个 `pending` 任务执行。
3. 执行任务对应验收命令（成功则 done，失败则 blocked+记录）。
4. 写日志、改状态、commit。
5. 进入下一任务，持续循环。

## 6. 输出要求（每轮结束）
仅输出 4 项：
1. 本轮变更文件列表（路径 + 一句话）
2. 本轮 commit hash + message
3. 任务状态变化（哪些从 pending/in_progress 变为 done/blocked）
4. 若 blocked：最多 3 条“最小人工操作步骤”

严格执行以上规则，不要只给方案，直接动手。

## 7. 2026-02-19 最新进展（自动续跑）
- 已执行：终止旧的长时间 `phase4` 运行。
- 已调整：`scripts/run_riscof_zabha_auto.sh` 将 `phase4` 拆分为 `phase4_1..phase4_4`，并在 `auto` 模式下自动衔接。
- 当前建议：继续执行同一命令 `bash /home/fengde/SAIL/scripts/run_riscof_zabha_auto.sh`，每次只跑一个 chunk，降低崩溃与长阻塞风险。
- 边界不变：`phase5` 仍依赖本机 GNU toolchain 对 Zabha 指令的支持。

## 8. 2026-02-19 自动续跑进度
- 已恢复执行并完成 `phase1`：smoke fallback 共 18 个用例，全部通过。
- 当前阶段文件：`/home/fengde/SAIL/riscv-arch-test/work-zabha/.auto_stage_state` 为 `phase1_done`。
- 下一步保持同一命令：`bash /home/fengde/SAIL/scripts/run_riscof_zabha_auto.sh`，将自动进入 `phase2`。

## 9. 2026-02-19 自动续跑进度
- `phase2` 已通过：`core_compat` 20 个用例全部通过。
- 当前阶段文件：`/home/fengde/SAIL/riscv-arch-test/work-zabha/.auto_stage_state` 为 `phase2_done`。
- 下一步继续同一命令，自动进入 `phase3`。

## 10. 2026-02-19 阶段拆分更新
- 已将 `phase5` 拆分为 `phase5_1..phase5_4`，与 `phase4` 一样支持自动续跑。
- 已做验收：`phase5_1` 在当前本机返回 blocked（exit 3），原因是本机 GNU toolchain 缺少 Zabha 指令支持。
- 主线继续：先跑完 `phase3` 与 `phase4` 分块；拿到支持 Zabha 的工具链后再继续 `phase5` 分块。

## 11. 2026-02-19 自动续跑进度
- `phase3` 已通过：`wide_compat` 选择 240 个用例，阶段完成并写入 `phase3_done`。
- 下一步自动进入 `phase4_1`（phase4 已拆成 4 个 chunk）。
- `phase5` 也已拆成 4 个 chunk，但本机仍受限于 Zabha 工具链能力。

## 12. 2026-02-19 颗粒度调整
- `phase4` 已从 4 个 chunk 调整为 12 个 chunk（每块约为原来的 1/3）。
- 目的：降低中断/崩溃时的重跑损失，缩短单次等待时间。
- 用法不变：仍只需执行 `bash /home/fengde/SAIL/scripts/run_riscof_zabha_auto.sh`，自动续跑到下一个未完成 chunk。

## 13. 2026-02-19 分块再细化
- `phase4` 已从 12 个 chunk 调整为 24 个 chunk。
- 目的：进一步缩短单次执行时长，并把崩溃后的重跑损失降到更小。
- 执行方式不变：继续使用 `bash /home/fengde/SAIL/scripts/run_riscof_zabha_auto.sh` 自动续跑。
- 结果要求更新：每完成 `phase4_x` 的一个子块，立即输出该子块的测试结果并提交一次。

## 14. 2026-02-19 phase4 子块进度
- 已完成：`phase4_1`（24 分块中的第 1 块）。
- 结果：`79/79` 通过，状态文件为 `phase4_1_done`。
- 下一步：继续执行 `bash /home/fengde/SAIL/scripts/run_riscof_zabha_auto.sh`，自动进入 `phase4_2`。

## 15. 2026-02-19 phase4 子块进度
- 已完成：`phase4_2`（24 分块中的第 2 块）。
- 结果：`79/79` 通过，状态文件为 `phase4_2_done`。
- 下一步：继续执行 `bash /home/fengde/SAIL/scripts/run_riscof_zabha_auto.sh`，自动进入 `phase4_3`。

## 16. 2026-02-19 phase4 子块进度
- 已完成：`phase4_3`（24 分块中的第 3 块）。
- 结果：`79/79` 通过，状态文件为 `phase4_3_done`。
- 下一步：继续执行 `bash /home/fengde/SAIL/scripts/run_riscof_zabha_auto.sh`，自动进入 `phase4_4`。

## 17. 2026-02-20 phase4 子块进度
- 已完成：`phase4_4`（24 分块中的第 4 块）。
- 结果：`79/79` 通过，状态文件为 `phase4_4_done`。
- 下一步：继续执行 `bash /home/fengde/SAIL/scripts/run_riscof_zabha_auto.sh`，自动进入 `phase4_5`。
- 分块设计源文件：`scripts/run_riscof_zabha_auto.sh`（含 `PHASE4_CHUNKS`、`PHASE5_CHUNKS`、`prepare_stage4_subtasks`、`prepare_stage5_subtasks`）。
- 监控结论：长时间无输出主要来自 `riscof -> make -j1` 静默执行；后续建议在脚本加入 heartbeat，必要时再把 `phase4` 继续细分。

## 18. 2026-02-20 phase4 粒度与并行度更新
- 已调整：`phase4` 从 24 分块细化为 48 分块。
- 已调整：rv64 riscof 插件并行度从 `jobs=1` 升级为 `jobs=2`（DUT/Reference 同步）。
- 设计源文件：
  - `scripts/run_riscof_zabha_auto.sh`（`PHASE4_CHUNKS=48`、phase4 解析与分块）
  - `riscv-arch-test/riscof-plugins/rv64/config.ini`（`jobs=2`）
- 已执行：`phase4_5`，结果 `40/40` 通过，状态文件为 `phase4_5_done`。
- 下一步：继续执行 `bash /home/fengde/SAIL/scripts/run_riscof_zabha_auto.sh`，自动进入 `phase4_6`。

## 19. 2026-02-20 phase4_6 进度与 j2 固化
- 现状：`phase4` 已按 48 分块执行，当前检查点为 `phase4_6_done`。
- 本轮结果：`phase4_6` 运行 `40` 个用例，`40/40` 通过。
- 并行策略：`jobs=2` 已改为脚本运行时注入，不依赖直接修改子模块配置文件。
- 关键实现文件：`scripts/run_riscof_zabha_auto.sh`（`prepare_runtime_config` + `RUNTIME_CFG_FILE` + `RISCOF_JOBS`）。
- 下一步：继续执行 `bash /home/fengde/SAIL/scripts/run_riscof_zabha_auto.sh` 自动进入 `phase4_7`。

## 20. 2026-02-20 phase4_7 自动进度
- 已完成：`phase4_7`（48 分块）。
- 结果：`40/40` 通过，状态文件为 `phase4_7_done`。
- 下一步：自动继续到 `phase4_8`。

## 2026-02-20 phase4_8 自动进度
- 已完成：（48 分块）。
- 结果： 通过，状态文件为 。
- 下一步：自动继续到 。

## 2026-02-20 phase4_10 自动进度
- 已完成：（48 分块）。
- 结果： 通过，状态文件为 。
- 下一步：自动继续到 。

## 2026-02-20 phase4_12 自动进度
- 已完成：（48 分块）。
- 结果： 通过，状态文件为 。
- 下一步：自动继续到 。

## 2026-02-20 phase4_14 自动进度
- 已完成：（48 分块）。
- 结果： 通过，状态文件为 。
- 下一步：自动继续到 。

## 2026-02-20 phase4_16 自动进度
- 已完成：（48 分块）。
- 结果： 通过，状态文件为 。
- 下一步：自动继续到 。

## 2026-02-20 phase4_18 自动进度
- 已完成：（48 分块）。
- 结果： 通过，状态文件为 。
- 下一步：自动继续到 。

## 21. 2026-02-20 PH4 heartbeat 监控文件
- 新增监控文件：`docs/PH4_HEARTBEAT.md`。
- 用途：单文件查看 phase4 总进度（done/remaining/progress/current-next/last-log）。
- 自动更新源：`scripts/auto_phase4_loop.sh` 每个子块前后都会刷新 heartbeat。
- 推荐监控命令：`watch -n 5 'cat /home/fengde/SAIL/docs/PH4_HEARTBEAT.md'`。

## 2026-02-20 phase4_19 自动进度
- 已完成：phase4_19（48 分块）。
- 结果：40/40 通过，状态文件为 phase4_19_done。
- 下一步：自动继续到 phase4_20。

## 2026-02-20 phase4_20 自动进度
- 已完成：phase4_20（48 分块）。
- 结果：40/40 通过，状态文件为 phase4_20_done。
- 下一步：自动继续到 phase4_21。

## 2026-02-20 phase4_21 自动进度
- 已完成：phase4_21（48 分块）。
- 结果：40/40 通过，状态文件为 phase4_21_done。
- 下一步：自动继续到 phase4_22。

## 2026-02-20 phase4_22 自动进度
- 已完成：phase4_22（48 分块）。
- 结果：40/40 通过，状态文件为 phase4_22_done。
- 下一步：自动继续到 phase4_23。

## 2026-02-20 phase4_23 自动进度
- 已完成：phase4_23（48 分块）。
- 结果：40/40 通过，状态文件为 phase4_23_done。
- 下一步：自动继续到 phase4_24。

## 2026-02-20 phase4_24 自动进度
- 已完成：phase4_24（48 分块）。
- 结果：40/40 通过，状态文件为 phase4_24_done。
- 下一步：自动继续到 phase4_25。

## 2026-02-20 phase4_25 自动进度
- 已完成：phase4_25（48 分块）。
- 结果：40/40 通过，状态文件为 phase4_25_done。
- 下一步：自动继续到 phase4_26。

## 22. 2026-02-20 断联期间续跑提示词（可直接复制）
- 当前时间：2026-02-20T12:20:52+08:00。
- 当前总进度：phase4 已完成 25/48，下一块是 phase4_26。
- 当前模式：`scripts/auto_phase4_loop.sh` 正在服务器端自动连续运行。
- 断联建议：不需要停任务；网络恢复后先读 `docs/PH4_HEARTBEAT.md` 与 `docs/auto_phase4_logs/`。
- 严禁操作：不要并行再启动第二个 auto loop，避免同一 work 目录冲突。
- 恢复后可执行：
  - `cat /home/fengde/SAIL/docs/PH4_HEARTBEAT.md`
  - `ls -1t /home/fengde/SAIL/docs/auto_phase4_logs | head -n 3`
  - `tail -n 80 /home/fengde/SAIL/docs/auto_phase4_logs/$(ls -1t /home/fengde/SAIL/docs/auto_phase4_logs | head -n 1)`
- 若发现自动循环已停止且未完成 phase4：
  - `bash /home/fengde/SAIL/scripts/auto_phase4_loop.sh`
- 对接提示（给后续助手）：
  - 目标：继续盯 phase4 自动循环，要求每完成一个 chunk 就在聊天框汇报一次。
  - 约束：机器只有 2 CPU，保持单 agent 串行，不做多 agent 并行跑测。

## 2026-02-20 phase4_26 自动进度
- 已完成：phase4_26（48 分块）。
- 结果：40/40 通过，状态文件为 phase4_26_done。
- 下一步：自动继续到 phase4_27。

## 2026-02-20 phase4_27 自动进度
- 已完成：phase4_27（48 分块）。
- 结果：40/40 通过，状态文件为 phase4_27_done。
- 下一步：自动继续到 phase4_28。

## 2026-02-20 phase4_28 自动进度
- 已完成：phase4_28（48 分块）。
- 结果：40/40 通过，状态文件为 phase4_28_done。
- 下一步：自动继续到 phase4_29。

## 2026-02-20 phase4_29 自动进度
- 已完成：phase4_29（48 分块）。
- 结果：40/40 通过，状态文件为 phase4_29_done。
- 下一步：自动继续到 phase4_30。

## 2026-02-20 phase4_30 自动进度
- 已完成：phase4_30（48 分块）。
- 结果：40/40 通过，状态文件为 phase4_30_done。
- 下一步：自动继续到 phase4_31。
