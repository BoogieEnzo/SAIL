# Agent执行计划（AI内部）

## 执行模式说明

**串行执行**：Agent按顺序启动，非并行
**里程碑汇报**：每个里程碑完成后向用户汇报
**代理类型**：根据任务需要启动不同类型的代理

---

## M1阶段：规范与ACT结构分析

### Agent 1: 规范搜索专员（librarian）
**启动时机**：M1开始时
**任务**：
- 下载Zabha规范文档（PDF）
- 提取所有18条指令的详细信息（编码、操作语义）
- 确认对齐要求和边界情况
- 分析ACT现有测试结构

**交付物**：
- Zabha规范PDF本地路径
- 指令列表（含编码、功能、对齐要求）
- ACT仓库结构分析

**预计用时**：2-3小时

---

### Agent 2: ACT测试分析专员（explore）
**启动时机**：M1开始时（与Agent 1同时）
**任务**：
- 分析ACT仓库结构（riscv-arch-test）
- 研究A扩展在ACT中的测试实现
- 提取测试模板（测试定义、自检测试代码结构）
- 理解测试覆盖率和验证流程

**交付物**：
- ACT代码结构分析
- 可复用的测试模板
- 测试实现模式总结

**预计用时**：2-3小时

---

### Agent 3: 冲突检查专员（explore）
**启动时机**：M1开始时（与Agent 1、2同时）
**任务**：
- 检查ACT仓库中是否已有Zabha测试
- 搜索GitHub Issues和PRs，确认是否有重复工作
- 确认测试需求（sail-riscv已支持但ACT缺少测试）
- 评估测试开发可行性

**交付物**：
- "无冲突"确认或冲突报告
- 相关PR/Issue列表（如有）
- 建议行动（继续/等待/换方案）

**预计用时**：1-2小时

---

### M1整合（主AI执行）
**时机**：所有Agent完成后
**任务**：
- 整合所有Agent结果
- 准备M1汇报内容（规范分析+ACT结构）
- 确认测试开发计划
- **向用户汇报M1**

---

## M2阶段：测试框架与基础测试实现

### Agent 4: 测试框架搭建专员（quick）
**启动时机**：用户确认M1后继续
**任务**：
- 创建Zabha测试目录结构（参考A扩展）
- 创建测试配置文件（test_pool、测试定义）
- 编写1-2条指令的基础测试（如AMOADD.B）
- 确保测试框架能正确编译和运行

**交付物**：
- 测试目录结构已创建
- 配置文件已设置
- 1-2条指令的基础测试代码
- 测试能运行确认

**预计用时**：2-3小时

---

### Agent 5: 完整测试开发专员（deep）
**启动时机**：Agent 4完成后
**任务**：
- 实现剩余14条指令的测试
- 覆盖所有操作类型（ADD/SWAP/AND/OR/XOR/MIN/MAX）
- 覆盖字节和半字数据类型
- 添加对齐和非对齐地址测试
- 添加边界情况测试

**交付物**：
- 全部18条指令的测试代码
- 测试覆盖率报告
- 所有测试通过确认

**预计用时**：4-6小时

---

### M2整合（主AI执行）
**时机**：所有Agent完成后
**任务**：
- 验证所有代码
- 准备M2汇报内容（代码展示）
- **向用户汇报M2**

---

## M3阶段：集成与测试

### Agent 6: 页表集成专员（deep）
**启动时机**：用户确认M2后继续
**任务**：
- 分析页表遍历代码（model/sys/vmem_ptw.sail）
- 确定CSR检查插入点
- 实现集成逻辑
- 如太复杂，准备简化方案说明

**交付物**：
- 修改后的页表代码（或简化版本说明）
- 集成逻辑说明

**预计用时**：4-8小时（取决于复杂度）

---

### Agent 7: 测试验证专员（unspecified-high）
**启动时机**：Agent 6完成后
**任务**：
- 运行 make 编译整个项目
- 运行 make test 执行测试套件
- 修复编译错误
- 修复测试失败
- 创建简单功能测试（如需要）

**交付物**：
- 测试通过报告
- 或测试失败记录及修复建议

**预计用时**：2-4小时

---

### M3整合（主AI执行）
**时机**：所有Agent完成后
**任务**：
- 验证所有测试通过
- 准备M3汇报内容
- **向用户汇报M3**

---

## M4阶段：PR提交

### Agent 8: PR准备专员（writing）
**启动时机**：用户确认M3后继续
**任务**：
- 准备PR描述（实现内容、参考规范、测试结果）
- 检查代码风格（CODE_STYLE.md）
- 准备commit message
- 整理文件修改列表

**交付物**：
- PR描述草稿
- Commit message建议
- 代码风格检查报告

**预计用时**：1-2小时

---

### Agent 9: 学习材料准备专员（writing）
**启动时机**：Agent 8同时
**任务**：
- 准备技术概念解释（通俗版，用rCore类比）
- 准备PPT大纲
- 准备Q&A回答
- 整理实现总结

**交付物**：
- 技术概念解释文档
- PPT大纲
- Q&A准备

**预计用时**：2-3小时

---

### M4整合（主AI执行）
**时机**：所有Agent完成后
**任务**：
- 准备最终汇报
- **询问用户GitHub信息**
- 提交PR（用户确认后）
- **向用户汇报M4**

---

## Agent调度顺序

```
M1
├── Agent 1 (规范搜索) ──┐
├── Agent 2 (代码分析) ──┼──> 主AI整合 ──> 汇报M1 ──> 用户确认
└── Agent 3 (冲突检查) ──┘

M2
├── Agent 4 (框架搭建) ──> 
└── Agent 5 (完整测试开发) ───> 主AI整合 ──> 汇报M2 ──> 用户确认

M3
├── Agent 6 (测试集成与适配) ──>
└── Agent 7 (测试验证) ──> 主AI整合 ──> 汇报M3 ──> 用户确认

M4
├── Agent 8 (PR准备) ────┐
└── Agent 9 (学习材料) ──┼──> 主AI整合 ──> 询问GitHub信息 ──> 提交PR ──> 汇报M4
```

---

## 启动指令模板

### 启动Agent 1（规范搜索）
```
task(
  category="deep",
  load_skills=["git-master"],
  description="搜索Zabha规范",
  prompt="""
  [CONTEXT] 需要为ACT（riscv-arch-test）项目添加Zabha测试支持，首先需要确认官方规范细节。
  
  [GOAL] 找到Zabha的RISC-V规范文档，确认18条指令的编码、语义和约束。
  
  [REQUEST] 
  1. 搜索RISC-V官方规范库中的Zabha文档
  2. 确认Zabha是否已批准
  3. 提取18条指令列表（含.B/.H版本）
  4. 提取关键测试约束：对齐要求、异常行为、边界条件
  5. 输出可直接用于ACT测试设计的检查点
  
  [DELIVERABLE]
  - 规范文档链接或PDF路径
  - 18条指令详细列表
  - 关键约束清单（对齐/异常/边界）
  - 或"找不到规范"的报告
  """
)
```

### 启动Agent 2（代码分析）
```
task(
  category="explore",
  load_skills=["git-master"],
  description="分析ACT A扩展参考实现",
  prompt="""
  [CONTEXT] 需要在ACT中新增Zabha测试，需要学习A扩展在ACT中的测试实现模式。
  
  [GOAL] 分析A扩展测试，提取可复用的测试模板。
  
  [REQUEST]
  1. 分析 riscv-test-suite 中A扩展测试目录结构
  2. 分析测试定义、test_pool、宏和自检汇编组织方式
  3. 分析rv32/rv64变体复用方式
  4. 提取可复用模板（可替换指令即用）
  5. 总结ACT测试开发的实现模式
  
  [DELIVERABLE]
  - ACT A扩展代码结构分析文档
  - 可复用代码模板
  - 实现模式总结
  """
)
```

### 启动Agent 3（冲突检查）
```
task(
  category="explore",
  load_skills=["git-master"],
  description="检查Zabha测试实现冲突",
  prompt="""
  [CONTEXT] 计划在ACT中实现Zabha测试，需要确认没有重复工作。
  
  [GOAL] 检查riscv-arch-test中Zabha测试的实现状态与外部冲突风险。
  
  [REQUEST]
  1. 搜索riscv-arch-test代码库中是否有Zabha测试
  2. 搜索GitHub Issues中是否有Zabha测试相关讨论
  3. 搜索GitHub PRs中是否有Zabha测试实现
  4. 判断是否存在重复开发风险
  5. 评估继续实现的风险
  
  [DELIVERABLE]
  - "无冲突"确认或详细冲突报告
  - 相关PR/Issue列表
  - 行动建议（继续/等待/换方案）
  """
)
```

---

## 主AI职责

1. **调度Agent**：按顺序启动Agent，等待完成
2. **整合结果**：收集所有Agent输出，形成统一汇报
3. **向用户汇报**：每个里程碑完成后汇报
4. **决策**：在Agent结果不一致时做出判断
5. **代码最终审核**：确保代码质量符合要求

---

## 风险应对

| 风险 | Agent | 应对 |
|------|-------|------|
| 规范找不到 | Agent 1 | 搜索RISC-V官方规范镜像与历史版本 |
| 代码分析不充分 | Agent 2 | 要求分析更多参考实现 |
| 发现冲突 | Agent 3 | 建议用户换方案或等待 |
| 框架搭建失败 | Agent 4 | 检查依赖关系，重试或询问用户 |
| 完整测试开发复杂 | Agent 5 | 分操作类型逐步覆盖并持续验证 |
| 测试集成适配复杂 | Agent 6 | 先最小可运行集成，再扩展全部指令 |
| 测试失败 | Agent 7 | 修复或记录问题询问用户 |

---

## 下一步

**准备启动**：M1阶段

**立即执行**：
1. 启动Agent 1（规范搜索）
2. 启动Agent 2（代码分析）
3. 启动Agent 3（冲突检查）
4. 等待所有Agent完成
5. 整合结果
6. **向你汇报M1**

**是否现在开始执行？**
