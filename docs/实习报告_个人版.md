# 实习阶段报告（个人版）

## 0. 当前状态摘要

- **已完成**：工程推进与阶段验证的主体工作；phase1～phase4 已执行并通过。
- **未完成**：最终考核闭环——PR 提交、CI 通过、技术汇报。
- **阻塞原因**：本机 GNU 工具链（riscv64-unknown-elf-gcc/binutils）不支持 Zabha 指令编码，导致 phase5 无法完成全量汇编与验收。
- **近期进展**：已在 fork 仓库配置 OpenCode workflow，通过 Issue 评论 `/oc` 或 `/opencode` 可触发 GitHub Actions。

---

## 1. 核心概念（项目相关）

### 1.1 ACT 的定位与作用

- **定义**：`riscv-arch-test` 是 RISC-V 架构一致性测试套件，提供标准化测试用例与判定规则。
- **作用**：用于验证目标实现（模拟器或硬件）是否符合 RISC-V ISA 规范。
- **本实习任务**：为 Zabha 扩展补充测试用例及对应的预期结果与判定逻辑。

**说明**：无 ACT 覆盖时，无法对“支持 Zabha”的声明做自动化验证；有 ACT 后，可通过自动化运行得到每条指令的通过/失败结果。

**示例（ACT 测试用例形态）**：单条指令的测试通常用宏写出输入操作数与预期结果，由框架比对 DUT 输出与预期值。例如通用寄存器—寄存器运算的宏：

```c
TEST_RR_OP(andn, x30, x29, x28, 0x10000000, 0xffffffff, 0x7fffffff, x1, 4, x2)
// 含义：指令 andn，结果寄存器 x30，操作数 x29/x28，预期值 0x10000000，rs1/rs2 的值 0xffffffff/0x7fffffff
```

自动化流程会运行该用例，比较实际结果与 `0x10000000`，一致则通过。

### 1.2 Zabha 扩展要点

- **定义**：Zabha 是 A 扩展的补充，提供字节（8-bit）与半字（16-bit）的原子内存操作。
- **原子语义**：读-改-写在同一指令内完成，中间不可被其他访问打断。
- **与普通访存区别**：需由硬件保证单条原子语义，而非多条 load/store 的软件组合。

**示例（Zabha 指令）**：Zabha 增加字节/半字原子操作，汇编中可见如下形式（本实习涉及的指令之一）：

```asm
amoadd.b  x1, x2, (x3)   /* 原子：将 (x3) 指向的字节读入，加 x2 低 8 位，写回，结果写入 x1 */
```

若工具链不支持 Zabha，在汇编或编译阶段会报“未知指令”等错误。

### 1.3 工具链阻塞原因

- **现象**：汇编/编译阶段报错，工具链无法识别 `amoadd.b` 等 Zabha 指令。
- **原因**：当前使用的 GNU 工具链版本尚未支持 Zabha 的 opcode，属于工具链能力边界，与测试设计正确性无关。
- **结论**：需使用支持 Zabha 的 riscv64-unknown-elf-gcc/binutils 方能完成 phase5 全量验证。

**示例（工具链能力检查）**：脚本中通过尝试编译一条 Zabha 指令来探测工具链是否支持 Zabha；不支持时该步失败并阻断 phase5：

```bash
# 探测命令（-march 需包含 zabha）
riscv64-unknown-elf-gcc -c -march=rv64imafd_zicsr_zabha -mabi=lp64 zabha_probe.S -o zabha_probe.o
```

若本机工具链不支持 `zabha` 扩展，上述命令会报错，phase5 不会继续执行。

### 1.4 CI 与考核关系

- **CI（持续集成）**：在代码仓库中由事件触发的自动化流水线，通常包括构建、测试、静态检查等。
- **考核依据**：考核以 CI 的客观运行结果为准，而非仅凭“本地已测过”的说明。

### 1.5 云端 CI 已跑通内容

- **触发条件**：向 `BoogieEnzo/riscv-arch-test` 的 push（如提交 opencode workflow）触发 GitHub Actions。
- **执行内容**：按 `regress.yml` 执行完整回归：Pre-commit 检查 → QEMU 回归（rv32-max / rv64-max）、Vector Testgen、Build CTP、多配置 Sail 回归（RVA/RVB/RV20U、rv32/rv64-max 等）→ Matrix 回归 → ci_pass；整条流水线约 10 分钟，状态为 Success。
- **产出**：8 个 artifacts（各类回归日志及 ctp.html / ctp.pdf），可作为客观证据。
- **意义**：fork 上的 CI 链路已通；后续 PR 的验收将依赖该云端 CI 是否通过。

**示例（阶段进度证据）**：本地用“心跳文件”记录当前跑到哪一阶段，便于断点续跑与汇报。例如 phase4 完成后，心跳文件内容形如：

```
done_chunks: 48/48
progress: 100%
current_or_next: phase5_1
```

对应路径：`docs/PH4_HEARTBEAT.md`；phase5 的为 `docs/PH5_HEARTBEAT.md`。

### 1.6 OpenCode 集成含义

- **已完成**：在默认分支 `act4` 部署 `.github/workflows/opencode.yml`（仓库 `BoogieEnzo/riscv-arch-test`）；workflow 使用千问（阿里云 DashScope），需在仓库 Secrets 中配置 `DASHSCOPE_API_KEY`；在 Issue 中评论 `/oc` 或 `/opencode` 可触发该 workflow。
- **当前状态**：触发链路已打通；若出现 ProviderModelNotFoundError，需核对 workflow 中的模型 ID（如 `alibaba-cn/qwen-plus`）；若出现写权限相关报错，需在仓库 Settings → Actions 中为 GITHUB_TOKEN 授予 Read and write permissions 并允许创建/审批 PR。

**示例（workflow 中的触发与模型配置）**：`.github/workflows/opencode.yml` 里通过评论内容决定是否跑 OpenCode，并指定模型与密钥来源：

```yaml
if: contains(github.event.comment.body, '/oc') || contains(github.event.comment.body, '/opencode')
# ...
env:
  DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
with:
  model: alibaba-cn/qwen-plus
```

即在 Issue/PR 评论中写 `/oc` 或 `/opencode` 会触发该 job；模型由 `DASHSCOPE_API_KEY` 与 `model` 共同决定。

---

## 2. 汇报时可用的技术主线

1. 任务选择：为 ACT 补充 Zabha 测试，属于中等复杂度、可交付的工程任务。
2. 执行方式：采用分阶段自动化流程（phase1～phase5），而非单次手工执行。
3. 阶段进展：phase4 已完成，证据见心跳文件与阶段日志。
4. 阻塞定位：最终阶段阻塞来自工具链能力缺失，而非测试设计错误。
5. 自动化与后续：已配置 GitHub 自动化入口（`/oc` 可触发）、云端 regression CI 已跑通并产出 artifacts；下一步为确认 OpenCode 所需 Secret 与权限、完成 phase5 与 PR CI 闭环。

---

## 3. 需要能说明的三个“为什么”

### 3.1 为何不属于简单改动

- 本任务属于 ISA 扩展的测试支持，涉及规范理解、用例设计、自动化脚本与证据链管理，而非文档或配置的简单修改。

### 3.2 为何 AI 参与仍体现个人能力

- 个人贡献体现在：任务边界与目标定义、验收标准制定、风险判断与结果审计；将 AI 产出转化为可交付、可复现的工程结果，本身是工程能力的一部分。

### 3.3 为何尚不能称为最终完成

- 最终完成的判定条件为：PR 已提交、CI 通过、技术汇报完成。
- 当前缺口：尚缺支持 Zabha 的工具链这一外部依赖，导致 phase5 全量验证与完整 CI 闭环未完成。

---

## 4. 后续三步

1. 获取或构建支持 Zabha 的 `riscv64-unknown-elf-gcc/binutils`，并在本机或云端完成环境配置。
2. 重新执行 phase5 全量 Zabha 验证，将结果写入日志并保留截图等证据。
3. 确认仓库 Secret（如 `DASHSCOPE_API_KEY`）与 Actions 写权限已正确配置，确认 `/oc` 可稳定触发并回评；随后提交 PR，等待并通过 CI。

---

## 5. 结尾表述建议

本次实习已完成技术主体与工程化验证，当前阻塞来自工具链版本对 Zabha 的支持；在完成工具链升级后，可收口至 PR 与 CI 通过，并完成考核要求。
